<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atividade de Personalidade</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
        .editor-section, .card { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .editor-section { color: #333; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        h1 { color: #1a1a2e; margin-bottom: 20px; font-size: 1.8rem; }
        h2 { color: #555; font-size: 1.1rem; margin-bottom: 15px; }
        .instructions { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; line-height: 1.7; font-size: 0.95rem; }
        .instructions strong { font-size: 1.1rem; display: block; margin-bottom: 10px; }
        .rules { background: #f0f4ff; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #667eea; }
        .rules h3 { color: #1a1a2e; font-size: 0.95rem; margin-bottom: 10px; }
        .rules ul { margin-left: 20px; color: #444; font-size: 0.9rem; }
        .rules li { margin-bottom: 5px; }
        .editor { width: 100%; min-height: 350px; padding: 20px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1.05rem; line-height: 1.9; resize: vertical; font-family: Georgia, serif; background: #fafafa; }
        .editor:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.2); }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 5px; }
        .agent-section { border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; background: #fafafa; }
        .agent-input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; resize: vertical; min-height: 80px; margin-bottom: 10px; font-family: inherit; }
        .agent-btn, .finish-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; margin-bottom: 10px; }
        .agent-btn:hover:not(:disabled), .finish-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102,126,234,0.4); }
        .agent-btn:disabled, .finish-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .agent-response { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-left: 4px solid #4caf50; padding: 15px; border-radius: 8px; margin-top: 15px; max-height: 200px; overflow-y: auto; font-size: 0.95rem; line-height: 1.6; color: #2e7d32; }
        .tracking-indicator { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 10px 20px; border-radius: 25px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .tracking-indicator::before { content: '‚óè'; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-log { max-height: 100px; overflow-y: auto; font-size: 0.6rem; font-family: monospace; background: #1a1a2e; color: #0f0; padding: 10px; border-radius: 8px; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb); width: 0%; transition: width 0.5s; }
        .interaction-counter { text-align: center; padding: 12px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 10px; margin-top: 12px; font-size: 0.9rem; color: #856404; font-weight: 600; }
        .interaction-counter .count { font-size: 1.3rem; }
        .intermediate-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); z-index: 1000; justify-content: center; align-items: center; }
        .intermediate-content { background: white; padding: 50px; border-radius: 25px; text-align: center; max-width: 550px; color: #333; }
        .intermediate-content h1 { color: #1a1a2e; font-size: 2rem; margin-bottom: 20px; }
        .intermediate-content p { color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .enter-btn { padding: 18px 50px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; font-weight: 600; }
        .api-status { font-size: 0.8rem; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; }
        .api-status.connected { background: #d4edda; color: #155724; }
        .api-status.error { background: #f8d7da; color: #721c24; }
        .privacy-notice { font-size: 0.7rem; color: #888; text-align: center; margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .history-box { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.8rem; max-height: 80px; overflow-y: auto; }
        .counter-badge { display: inline-block; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="tracking-indicator" id="trackingIndicator">Rastreando sua experi√™ncia</div>
    <div class="container">
        <div class="editor-section">
            <h1>‚úçÔ∏è Descreva sua personalidade</h1>
            <div class="instructions">
                <strong>üéØ Objetivo</strong>
                Este √© o primeiro passo do seu <strong>Mapeamento de Letramento</strong>. 
                Vamos entender como voc√™ se percebe e como se expressa.
                <br><br>
                <strong>Como funciona:</strong> Voc√™ escreve sobre si mesmo e, se quiser, pode conversar com um especialista em personalidade que vai ajud√°-lo a refletir mais profundamente.
            </div>
            <div class="rules">
                <h3>üìã Regras da Atividade</h3>
                <ul>
                    <li>Escreva sobre <strong>sua personalidade</strong> ‚Äî quem voc√™ √©, o que te define</li>
                    <li>M√≠nimo <strong>100 palavras</strong>, m√°ximo <strong>200 palavras</strong></li>
                    <li>Use no <strong>m√°ximo 2 par√°grafos</strong></li>
                    <li>Voc√™ tem direito a <strong>5 intera√ß√µes</strong> com o especialista</li>
                    <li>Essas intera√ß√µes s√£o <strong>opcionais</strong> ‚Äî voc√™ pode finalizar quando quiser</li>
                </ul>
            </div>
            <textarea id="editor" class="editor" placeholder="Comece a escrever sobre voc√™... Por exemplo: 'Sou uma pessoa que...'"></textarea>
        </div>
        <div class="sidebar">
            <div class="card">
                <h2>üìä Estat√≠sticas</h2>
                <div class="stats">
                    <div class="stat"><div class="stat-value" id="charCount">0</div><div class="stat-label">Caracteres</div></div>
                    <div class="stat"><div class="stat-value" id="wordCount">0</div><div class="stat-label">Palavras</div></div>
                    <div class="stat"><div class="stat-value" id="paraCount">0</div><div class="stat-label">Par√°grafos</div></div>
                    <div class="stat"><div class="stat-value" id="timeSpent">0:00</div><div class="stat-label">Tempo</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            </div>
            <div class="card">
                <h2>üë§ Especialista em Personalidade <span class="counter-badge" id="interactionsUsed">0/5</span></h2>
                <div id="apiStatus" class="api-status">Verificando conex√£o...</div>
                <div class="agent-section">
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Quer ajuda para refletir? Converse com nosso especialista:</p>
                    <textarea id="agentQuestion" class="agent-input" placeholder="Responda ou fa√ßa perguntas ao especialista..."></textarea>
                    <button class="agent-btn" id="agentBtn" onclick="askAgent()">üí¨ Falar com Especialista</button>
                </div>
                <div class="interaction-counter">Intera√ß√µes: <span class="count" id="interactionCount">0</span> / 5 dispon√≠veis</div>
                <div id="historyBox" class="history-box" style="display:none;"></div>
                <div id="agentResponse" class="agent-response" style="display: none;"></div>
                <div class="privacy-notice">üîí Seus dados s√£o protegidos e privados</div>
            </div>
            <div class="card">
                <button class="finish-btn" id="finishBtn" onclick="finishAndProceed()" disabled>‚úì Finalizar Atividade</button>
            </div>
            <div class="card">
                <h2>üéØ Eventos</h2>
                <div class="event-log" id="eventLog"><div>Aguardando...</div></div>
            </div>
        </div>
    </div>
    <div class="intermediate-screen" id="intermediateScreen">
        <div class="intermediate-content">
            <h1>üéâ Atividade Conclu√≠da!</h1>
            <p>Obrigado por participar do Mapeamento de Letramento. Seus dados foram salvos com sucesso.</p>
            <button class="enter-btn" onclick="enterExperience()">Continuar</button>
        </div>
    </div>
    <script>
        const API_BASE = '';
        const MAX_INTERACTIONS = 5;
        
        let interactionsLeft = MAX_INTERACTIONS;
        let studentId = localStorage.getItem('studentId') || 'student_' + Date.now();
        localStorage.setItem('studentId', studentId);
        let startTime = Date.now();
        let sessionId = null;
        let apiConnected = false;
        
        async function checkAPI() {
            try {
                const res = await fetch(API_BASE + '/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    apiConnected = true;
                    document.getElementById('apiStatus').className = 'api-status connected';
                    document.getElementById('apiStatus').textContent = '‚úì Conectado ao sistema';
                    
                    const sessionRes = await fetch(API_BASE + '/api/session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId })
                    });
                    const sessionData = await sessionRes.json();
                    sessionId = sessionData.sessionId;
                    
                    trackEvent('session_start', { studentId, sessionId });
                }
            } catch (e) {
                document.getElementById('apiStatus').className = 'api-status error';
                document.getElementById('apiStatus').textContent = '‚úó Erro de conex√£o';
            }
        }
        
        checkAPI();
        
        function trackEvent(type, data) {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + type;
            log.insertBefore(entry, log.firstChild);
            console.log('üìä', type, data);
            
            if (apiConnected) {
                fetch(API_BASE + '/api/event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, eventType: type, data })
                }).catch(e => console.error('Erro ao enviar evento:', e));
            }
        }
        
        async function askAgent() {
            if (interactionsLeft <= 0) return;
            
            const btn = document.getElementById('agentBtn');
            const responseDiv = document.getElementById('agentResponse');
            const content = editor.value;
            const question = document.getElementById('agentQuestion').value;
            
            const combinedText = content + (question ? '\n\nPergunta do estudante: ' + question : '');
            
            btn.disabled = true;
            btn.textContent = 'ü§î Especialista refletindo...';
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = 'O especialista est√° refletindo sobre o que voc√™ escreveu...';
            
            try {
                const response = await fetch(API_BASE + '/api/agent/personality', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, studentText: combinedText })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    responseDiv.innerHTML = '<strong>üë§ Especialista:</strong><br><br>' + data.answer;
                    interactionsLeft--;
                    document.getElementById('interactionCount').textContent = MAX_INTERACTIONS - interactionsLeft;
                    document.getElementById('interactionsUsed').textContent = (MAX_INTERACTIONS - interactionsLeft) + '/' + MAX_INTERACTIONS;
                    
                    const historyBox = document.getElementById('historyBox');
                    historyBox.style.display = 'block';
                    historyBox.innerHTML = '<strong>Hist√≥rico:</strong> ' + (data.historyLength || 1) + ' mensagens';
                    
                    trackEvent('agent_response', { answer: data.answer, remaining: interactionsLeft });
                }
                
                document.getElementById('agentQuestion').value = '';
                btn.disabled = interactionsLeft <= 0;
                btn.textContent = interactionsLeft <= 0 ? '‚úì Limite atingido' : 'üí¨ Falar com Especialista';
                
            } catch (error) {
                responseDiv.innerHTML = 'Erro de conex√£o. Tente novamente.';
                btn.disabled = false;
                btn.textContent = 'üí¨ Falar com Especialista';
            }
        }
        
        const editor = document.getElementById('editor');
        editor.addEventListener('input', () => {
            const text = editor.value;
            updateStats(text);
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            document.getElementById('finishBtn').disabled = words < 100;
            trackEvent('input', { chars: text.length, words: words });
        });
        
        let lastMouseMove = Date.now();
        document.addEventListener('mousemove', (e) => {
            if (Date.now() - lastMouseMove > 500) {
                trackEvent('mousemove', { x: Math.round(e.clientX), y: Math.round(e.clientY) });
                lastMouseMove = Date.now();
            }
        });
        document.addEventListener('click', (e) => trackEvent('click', { target: e.target.tagName }));
        
        function updateStats(text) {
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const paras = text.split(/\n\n+/).filter(p => p.trim()).length;
            
            document.getElementById('charCount').textContent = chars;
            document.getElementById('wordCount').textContent = words;
            document.getElementById('paraCount').textContent = paras;
            
            // Progress based on words (100-200 range)
            const progress = Math.min(100, Math.max(0, ((words - 100) / 100) * 100));
            document.getElementById('progress').style.width = progress + '%';
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timeSpent').textContent = Math.floor(elapsed/60) + ':' + (elapsed%60).toString().padStart(2,'0');
        }
        
        function finishAndProceed() {
            const words = editor.value.trim().split(/\s+/).length;
            trackEvent('finish', { words: words, paragraphs: document.getElementById('paraCount').textContent });
            document.getElementById('intermediateScreen').style.display = 'flex';
        }
        
        function enterExperience() {
            alert('Em breve: pr√≥ximo m√≥dulo do Mapeamento de Letramento!');
            location.reload();
        }
        
        setInterval(() => updateStats(editor.value), 1000);
    </script>
</body>
</html>
